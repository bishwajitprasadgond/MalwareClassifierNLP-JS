import pandas as pd
import os

def compare_csv(file1_path, file2_path, family_column):
    # Extract headers from the single CSV file (file2)
    file2_df = pd.read_csv(file2_path)
    headers = set(file2_df['Unigram'])

    # Initialize examples list and a dictionary to keep track of counts
    examples = []
    counts_dict = {}

    # Iterate through all CSV files in file1_path
    for file1 in os.listdir(file1_path):
        if file1.endswith('.csv'):
            file1_full_path = os.path.join(file1_path, file1)

            # Read the CSV file from file1_path
            file1_df = pd.read_csv(file1_full_path, skiprows=1)

            # Skip initializing the example if the CSV is empty
            if file1_df.empty:
                continue
            
            # Initialize example as a dictionary
            example = {}

            # Add file name (without extension) and family column to the example
            example['name'] = os.path.splitext(os.path.basename(file1_full_path))[0]
            #os.path.splitext(os.path.basename(file1_full_path))[0].split('_')[0]
            example['family'] = family_column
            #os.path.splitext(os.path.basename(file1_full_path))[0].split('_')[1]

            # Compare lines and create examples
            for index, row in file1_df.iterrows():
                # Convert the row to a tuple for efficient comparison and hashing
                row_tuple = tuple(row)

                # Increment count for each row feature
                counts_dict[row_tuple] = counts_dict.get(row_tuple, 0) + 1
                example[f'{",".join(map(str, row))}'] = counts_dict[row_tuple]

            examples.append(example)

    return examples

# Example usage:
file1_path = r'D:\Malware\unigram_analysis\adware_unigram_created'
file2_path = r'D:\Malware\unigram_analysis\unique_unigram\unigram\50k\adware.csv'
family_column = 'Adware'  # Change this to the desired family name

result_examples = compare_csv(file1_path, file2_path, family_column)
print(result_examples[:1])

# Save the DataFrames to new CSV files
result_df = pd.DataFrame(result_examples)
result_df = result_df.fillna(0)  # Replace NaN with 0
result_df.to_csv(r'D:\Malware\feature_vector\unigram\adware.csv', index=False, sep=',')
